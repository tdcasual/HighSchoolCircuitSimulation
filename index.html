<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电路模拟器 - Circuit Simulator</title>
    <link rel="stylesheet" href="css/style.css">
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="MathJax-script" async></script>
</head>
<body>
    <div id="app">
        <!-- 左侧工具箱 -->
        <aside id="toolbox">
            <h2>元器件</h2>
            <div class="tool-category">
                <h3>电源</h3>
                <div class="tool-item" data-type="PowerSource" draggable="true">
                    <svg viewBox="0 0 60 40" width="60" height="40">
                        <line x1="0" y1="20" x2="20" y2="20" stroke="#333" stroke-width="2"/>
                        <line x1="20" y1="8" x2="20" y2="32" stroke="#333" stroke-width="3"/>
                        <line x1="28" y1="14" x2="28" y2="26" stroke="#333" stroke-width="2"/>
                        <line x1="28" y1="20" x2="60" y2="20" stroke="#333" stroke-width="2"/>
                    </svg>
                    <span>电源</span>
                </div>
            </div>
            <div class="tool-category">
                <h3>电阻类</h3>
                <div class="tool-item" data-type="Resistor" draggable="true">
                    <svg viewBox="0 0 60 40" width="60" height="40">
                        <line x1="0" y1="20" x2="10" y2="20" stroke="#333" stroke-width="2"/>
                        <rect x="10" y="12" width="40" height="16" fill="none" stroke="#333" stroke-width="2"/>
                        <line x1="50" y1="20" x2="60" y2="20" stroke="#333" stroke-width="2"/>
                    </svg>
                    <span>定值电阻</span>
                </div>
                <div class="tool-item" data-type="Rheostat" draggable="true">
                    <svg viewBox="0 0 60 40" width="60" height="40">
                        <line x1="0" y1="20" x2="10" y2="20" stroke="#333" stroke-width="2"/>
                        <rect x="10" y="12" width="40" height="16" fill="none" stroke="#333" stroke-width="2"/>
                        <line x1="50" y1="20" x2="60" y2="20" stroke="#333" stroke-width="2"/>
                        <line x1="20" y1="5" x2="40" y2="30" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                    </svg>
                    <span>滑动变阻器</span>
                </div>
            </div>
            <div class="tool-category">
                <h3>其他元件</h3>
                <div class="tool-item" data-type="Bulb" draggable="true">
                    <svg viewBox="0 0 60 40" width="60" height="40">
                        <line x1="0" y1="20" x2="15" y2="20" stroke="#333" stroke-width="2"/>
                        <circle cx="30" cy="20" r="12" fill="none" stroke="#333" stroke-width="2"/>
                        <line x1="22" y1="12" x2="38" y2="28" stroke="#333" stroke-width="1.5"/>
                        <line x1="38" y1="12" x2="22" y2="28" stroke="#333" stroke-width="1.5"/>
                        <line x1="45" y1="20" x2="60" y2="20" stroke="#333" stroke-width="2"/>
                    </svg>
                    <span>灯泡</span>
                </div>
                <div class="tool-item" data-type="Capacitor" draggable="true">
                    <svg viewBox="0 0 60 40" width="60" height="40">
                        <line x1="0" y1="20" x2="25" y2="20" stroke="#333" stroke-width="2"/>
                        <line x1="25" y1="8" x2="25" y2="32" stroke="#333" stroke-width="2"/>
                        <line x1="35" y1="8" x2="35" y2="32" stroke="#333" stroke-width="2"/>
                        <line x1="35" y1="20" x2="60" y2="20" stroke="#333" stroke-width="2"/>
                    </svg>
                    <span>电容</span>
                </div>
                <div class="tool-item" data-type="ParallelPlateCapacitor" draggable="true">
                    <svg viewBox="0 0 60 40" width="60" height="40">
                        <line x1="0" y1="20" x2="23" y2="20" stroke="#333" stroke-width="2"/>
                        <rect x="23" y="8" width="4" height="24" fill="none" stroke="#333" stroke-width="2"/>
                        <rect x="33" y="10" width="4" height="24" fill="none" stroke="#333" stroke-width="2"/>
                        <line x1="37" y1="20" x2="60" y2="20" stroke="#333" stroke-width="2"/>
                        <line x1="40" y1="7" x2="46" y2="3" stroke="#333" stroke-width="1.5"/>
                        <line x1="40" y1="7" x2="45" y2="9" stroke="#333" stroke-width="1.5"/>
                    </svg>
                    <span>平行板电容</span>
                </div>
                <div class="tool-item" data-type="Motor" draggable="true">
                    <svg viewBox="0 0 60 40" width="60" height="40">
                        <line x1="0" y1="20" x2="12" y2="20" stroke="#333" stroke-width="2"/>
                        <circle cx="30" cy="20" r="15" fill="none" stroke="#333" stroke-width="2"/>
                        <text x="30" y="25" text-anchor="middle" font-size="14" fill="#333">M</text>
                        <line x1="48" y1="20" x2="60" y2="20" stroke="#333" stroke-width="2"/>
                    </svg>
                    <span>电动机</span>
                </div>
                <div class="tool-item" data-type="Switch" draggable="true">
                    <svg viewBox="0 0 60 40" width="60" height="40">
                        <line x1="0" y1="20" x2="18" y2="20" stroke="#333" stroke-width="2"/>
                        <circle cx="20" cy="20" r="3" fill="#333"/>
                        <line x1="20" y1="20" x2="35" y2="8" stroke="#333" stroke-width="2.5"/>
                        <circle cx="40" cy="20" r="3" fill="#333"/>
                        <line x1="42" y1="20" x2="60" y2="20" stroke="#333" stroke-width="2"/>
                    </svg>
                    <span>开关</span>
                </div>
                <div class="tool-item" data-type="BlackBox" draggable="true">
                    <svg viewBox="0 0 60 40" width="60" height="40">
                        <rect x="14" y="9" width="32" height="22" rx="6" ry="6" fill="none" stroke="#333" stroke-width="2"/>
                        <circle cx="14" cy="20" r="3" fill="#2196F3" stroke="#1565C0" stroke-width="1"/>
                        <circle cx="46" cy="20" r="3" fill="#2196F3" stroke="#1565C0" stroke-width="1"/>
                    </svg>
                    <span>黑箱</span>
                </div>
            </div>
            <div class="tool-category">
                <h3>测量仪表</h3>
                <div class="tool-item" data-type="Ammeter" draggable="true">
                    <svg viewBox="0 0 60 40" width="60" height="40">
                        <line x1="0" y1="20" x2="12" y2="20" stroke="#333" stroke-width="2"/>
                        <circle cx="30" cy="20" r="14" fill="#fff" stroke="#c00" stroke-width="2"/>
                        <text x="30" y="25" text-anchor="middle" font-size="14" fill="#c00" font-weight="bold">A</text>
                        <line x1="48" y1="20" x2="60" y2="20" stroke="#333" stroke-width="2"/>
                    </svg>
                    <span>电流表</span>
                </div>
                <div class="tool-item" data-type="Voltmeter" draggable="true">
                    <svg viewBox="0 0 60 40" width="60" height="40">
                        <line x1="0" y1="20" x2="12" y2="20" stroke="#333" stroke-width="2"/>
                        <circle cx="30" cy="20" r="14" fill="#fff" stroke="#00c" stroke-width="2"/>
                        <text x="30" y="25" text-anchor="middle" font-size="14" fill="#00c" font-weight="bold">V</text>
                        <line x1="48" y1="20" x2="60" y2="20" stroke="#333" stroke-width="2"/>
                    </svg>
                    <span>电压表</span>
                </div>
            </div>
            <div class="tool-category">
                <h3>操作</h3>
                <button id="btn-clear" class="action-btn">清空电路</button>
                <button id="btn-export" class="action-btn">导出JSON</button>
                <button id="btn-import" class="action-btn">导入JSON</button>
                <input type="file" id="file-import" accept=".json" style="display:none"/>
            </div>
        </aside>

        <!-- 主画布区域 -->
        <main id="canvas-container">
            <svg id="circuit-canvas" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
                    </marker>
                    <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                        <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e0e0e0" stroke-width="0.5"/>
                    </pattern>
                </defs>
                <!-- 网格层 -->
                <g id="layer-grid">
                    <rect width="100%" height="100%" fill="url(#grid)"/>
                </g>
                <!-- 导线层 -->
                <g id="layer-wires"></g>
                <!-- 元器件层 -->
                <g id="layer-components"></g>
                <!-- UI覆盖层 -->
                <g id="layer-ui"></g>
            </svg>
            <!-- 状态栏 -->
            <div id="status-bar">
                <span id="status-text">就绪</span>
                <span id="zoom-level">100%</span>
                <span id="simulation-status">模拟: 停止</span>
            </div>
        </main>

        <!-- 右侧观察面板（含“属性/观察”切换） -->
        <aside id="side-panel">
            <div class="side-panel-header">
                <h2>面板</h2>
                <div class="side-panel-tabs" role="tablist" aria-label="右侧面板">
                    <button class="panel-tab-btn active" data-panel="properties" role="tab" aria-selected="true">属性</button>
                    <button class="panel-tab-btn" data-panel="observation" role="tab" aria-selected="false">观察</button>
                </div>
            </div>

            <div class="side-panel-body">
                <section id="panel-properties" class="panel-page active" data-panel="properties" role="tabpanel">
                    <div id="property-content">
                        <p class="hint">选择一个元器件查看和编辑属性</p>
                    </div>
                </section>

                <section id="panel-observation" class="panel-page" data-panel="observation" role="tabpanel" aria-hidden="true">
                    <div id="observation-root">
                        <p class="hint">在这里添加函数图像与观察量配置（开发中）</p>
                    </div>
                </section>
            </div>

            <div class="side-panel-footer">
                <div id="simulation-controls">
                    <h3>模拟控制</h3>
                    <button id="btn-run" class="control-btn run">▶ 运行</button>
                    <button id="btn-stop" class="control-btn stop" disabled>■ 停止</button>
                </div>
            </div>
        </aside>
    </div>

    <!-- 属性编辑对话框 -->
    <div id="dialog-overlay" class="hidden">
        <div id="property-dialog">
            <h3 id="dialog-title">编辑属性</h3>
            <div id="dialog-content"></div>
            <div class="dialog-buttons">
                <button id="dialog-cancel">取消</button>
                <button id="dialog-ok">确定</button>
            </div>
        </div>
    </div>

    <!-- AI助手面板 -->
    <div id="ai-assistant-panel" class="collapsed">
        <div id="ai-panel-header">
            <h3>AI 助手</h3>
            <div id="ai-panel-actions">
                <button id="ai-settings-btn" title="设置">设置</button>
                <button id="ai-toggle-btn" title="展开/折叠">▲</button>
            </div>
        </div>
        <div id="ai-panel-content">
            <div id="ai-tabs">
                <button class="ai-tab active" data-tab="image">图片转电路</button>
                <button class="ai-tab" data-tab="explain">物理解释</button>
            </div>
            
            <!-- 图片转电路 Tab -->
            <div id="tab-image" class="ai-tab-content active">
                <div id="image-upload-zone">
                    <input type="file" id="circuit-image-input" accept="image/*" hidden>
                    <div id="image-drop-area">
                        <div id="image-preview-area" class="hidden">
                            <img id="image-preview" alt="Circuit preview">
                            <button id="image-remove-btn">×</button>
                        </div>
                        <div id="image-upload-prompt">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                            <p>拖放电路图片到这里，或点击上传</p>
                            <button id="image-upload-btn" class="primary-btn">选择图片</button>
                        </div>
                    </div>
                </div>
                <button id="convert-circuit-btn" class="primary-btn" disabled>转换为 JSON 并加载</button>
            </div>
            
            <!-- 物理解释 Tab -->
            <div id="tab-explain" class="ai-tab-content">
                <div id="chat-messages"></div>
                <div id="followup-actions">
                    <button class="followup-btn" data-mode="continue">继续讲解</button>
                    <button class="followup-btn" data-mode="simplify">换个说法</button>
                    <button class="followup-btn" data-mode="quiz">出道小测</button>
                </div>
                <div id="chat-controls">
                    <button id="chat-undo-btn">回撤上一轮</button>
                    <button id="chat-new-btn">新对话</button>
                    <select id="chat-history-select">
                        <option value="">历史记录</option>
                    </select>
                </div>
                <div id="quick-questions">
                    <button class="quick-question-btn">为什么R1的电流增大了?</button>
                    <button class="quick-question-btn">滑动变阻器如何影响电路?</button>
                    <button class="quick-question-btn">为什么电压表读数变化?</button>
                </div>
                <div id="chat-input-area">
                    <input type="text" id="chat-input" placeholder="问一个关于电路的问题..." />
                    <button id="chat-send-btn">发送</button>
                </div>
            </div>
        </div>
        <div id="ai-resize-handle" title="拖动调整大小"></div>
    </div>

    <!-- AI设置对话框 -->
    <div id="ai-settings-dialog" class="hidden">
        <div class="dialog-content">
            <h3>⚡ AI 设置</h3>
            <div class="form-group">
                <label>API 端点</label>
                <input type="text" id="api-endpoint" placeholder="https://api.openai.com/v1/chat/completions" />
            </div>
            <div class="form-group">
                <label>API 密钥</label>
                <input type="password" id="api-key" placeholder="sk-..." />
            </div>
            <div class="form-group">
                <label>视觉模型 (图片转换)</label>
                <div class="model-input-row">
                    <select id="vision-model-select">
                        <option value="">从列表选择</option>
                    </select>
                    <input type="text" id="vision-model" list="model-list-vision" placeholder="gpt-4o-mini-vision" />
                </div>
                <datalist id="model-list-vision"></datalist>
            </div>
            <div class="form-group">
                <label>文本模型 (物理解释)</label>
                <div class="model-input-row">
                    <select id="text-model-select">
                        <option value="">从列表选择</option>
                    </select>
                    <input type="text" id="text-model" list="model-list-text" placeholder="gpt-4o-mini" />
                </div>
                <datalist id="model-list-text"></datalist>
            </div>
            <div class="dialog-buttons">
                <button id="settings-fetch-models-btn">获取模型</button>
                <button id="settings-clear-key-btn">清除密钥</button>
                <button id="settings-test-btn">测试连接</button>
                <button id="settings-cancel-btn">取消</button>
                <button id="settings-save-btn" class="primary-btn">保存</button>
            </div>
            <div id="model-fetch-status" class="hint-text"></div>
        </div>
    </div>

    <!-- 脚本加载 -->
    <script type="module" src="src/main.js"></script>
</body>
</html>
