# 高中电路模拟器：动态响应与触屏体验设计（含审计）

## 1. 背景与目标

本次目标不是仅做样式微调，而是基于现有代码的交互模型，完成一套可落地的响应式与触屏升级方案，确保在桌面、平板、手机三类场景下都能稳定完成核心任务：

- 放置元件、连线、移动与缩放
- 编辑属性、旋转、删除、分割导线
- 运行仿真并查看观测结果

## 2. 审计结论（关键问题）

### P0（高优先级，直接影响可用性）

1. 小屏布局没有真正生效  
`css/style.css` 的 `@media (max-width: 900px)` 仍在调整不存在的 `#property-panel`，实际右侧面板 `#side-panel` 没有响应式规则。  
影响：在平板竖屏/手机横屏下，三栏挤压导致画布操作区域过小。  
证据：`css/style.css:1211-1220`、`index.html:293`

2. 触屏缺少关键操作入口（旋转/删除/分割等）  
关键操作依赖右键菜单或键盘快捷键；触屏端没有等价入口。  
影响：手机/平板用户无法完整完成编辑闭环。  
证据：`src/app/interaction/InteractionOrchestrator.js:554-560`、`src/ui/interaction/EventBindingsController.js:62`、`src/ui/interaction/PropertyPanelController.js:417-420`

3. 浮动面板在窄屏存在最小尺寸硬约束  
AI 面板逻辑始终以 `minPanelWidth=320` 夹逼，结合 CSS 的 `min-width: 320px`，在窄屏易越界。  
影响：遮挡主画布，或无法稳定拖回视口。  
证据：`src/ui/AIPanel.js:37-39`、`src/ui/ai/PanelLayoutController.js:425-431`、`css/style.css:1851-1854`

### P1（中优先级，触屏体验显著下降）

1. 触控命中面积对关键对象不足  
开关触摸区域为 `24x18`，明显小于常见触控下限。  
影响：点按失败率高，误触高。  
证据：`src/components/Component.js:1004-1008`

2. 仅对粗指针做了局部增强，未形成系统化触控策略  
当前只放大了部分按钮和导线命中区，端子/开关/上下文操作未统一。  
证据：`css/style.css:2669-2683`、`src/components/Component.js:1302-1306`

### P2（低优先级，长期质量风险）

1. 缺少响应式 UI 自动化回归测试  
现有测试覆盖了 pointer/pinch 逻辑，但几乎没有布局断点行为验证。  
影响：后续改动容易回归。  
证据：`tests` 中相关项集中于交互逻辑，缺少 viewport 布局断言。

## 3. 备选方案对比

### 方案 A（推荐）：分级响应式 + 触屏优先交互层

- 保留现有桌面信息架构（左工具箱、中央画布、右面板）
- 在 `<=1200 / <=900 / <=680` 三段断点做布局重排
- 新增触屏操作层：长按动作菜单 + 底部快捷操作条 + 大命中区
- 优点：风险可控、迁移成本低、可分阶段上线
- 缺点：需要新增状态管理与较多兼容分支

### 方案 B：移动优先重构（单列 + 全抽屉）

- 手机为主，桌面通过媒体查询反向扩展
- 优点：移动端体验最一致
- 缺点：会大改现有桌面交互，回归面太大

### 方案 C：只做 CSS 断点修补

- 仅改布局与尺寸，不改交互模型
- 优点：上线最快
- 缺点：无法解决右键/快捷键依赖，触屏“能看不能用”

结论：选择方案 A。

## 4. 推荐设计（方案 A）

### 4.1 布局架构

新增 `LayoutMode`（由 viewport 宽度驱动）：

- `desktop`（>1200）：维持三栏
- `tablet`（901-1200）：左栏窄化，右栏可折叠
- `compact`（<=900）：主画布全宽；工具箱改左抽屉；属性/观察改底部抽屉
- `phone`（<=680）：抽屉全屏化，优先保证画布与操作按钮

关键规则：

- 所有固定宽度改为 `clamp()` 或 CSS 变量驱动
- 移除无效 `#property-panel` 规则，替换为 `#side-panel`
- `body` 和主要容器引入 `safe-area-inset` 适配

### 4.2 触屏交互架构

新增三类触屏机制：

1. 长按动作菜单（替代右键）  
- 长按组件/导线 420ms 弹出动作菜单  
- 菜单项对齐现有右键能力（编辑/旋转/复制/删除/分割/探针）

2. 选中态快捷操作条（底部）  
- 组件选中后展示：编辑、旋转、复制、删除  
- 导线选中后展示：分割、拉直、探针、删除  
- 完全摆脱键盘依赖

3. 命中区统一放大  
- 端子、开关、导线端点统一最小 44px 命中框（逻辑尺寸）
- 保持视觉尺寸不变，仅扩大透明 hit-area

### 4.3 画布手势策略

- 单指：选择/拖拽元件
- 双指：缩放 + 平移（沿用现有 pinch 逻辑）
- 新增“平移模式按钮”：开启后单指优先平移画布（便于初学者）
- 保持 `touch-action: none`，但给出显式手势模式提示，避免误解

## 5. 组件与数据流调整

新增模块建议：

- `ResponsiveLayoutController`
  - 输入：`window.innerWidth/innerHeight`
  - 输出：`layoutMode`、抽屉开关状态、浮层最大尺寸
- `TouchActionController`
  - 统一长按计时、取消逻辑、动作菜单触发
- `QuickActionBarController`
  - 根据 `selectedComponent/selectedWire` 渲染触屏快捷操作

数据流：

1. pointer 事件进入 `PointerSessionManager`
2. `TouchActionController` 判断长按/拖拽冲突
3. 若为长按，走动作菜单；否则走原交互链
4. `ResponsiveLayoutController` 变化时通知面板与浮层重算约束

## 6. 错误处理与兼容策略

- 长按菜单在拖拽开始、双指触发、指针取消时必须自动取消
- 面板尺寸保存要记录 `layoutMode`，防止桌面尺寸污染手机布局
- 窄屏时浮层超过可视区，强制回退到默认位置并写回存储
- 无 PointerEvent 时继续保留 mouse fallback

## 7. 测试与验收

### 单元测试（新增）

- `responsiveLayoutController.spec.js`：断点切换、抽屉状态
- `touchActionController.spec.js`：长按触发/取消
- `quickActionBarController.spec.js`：选中态动作可见性
- `aiPanel.layout.spec.js` 扩展：窄屏下不越界

### 端到端测试（建议 Playwright）

- 390x844（手机）、768x1024（平板）、1366x768（桌面）
- 触屏脚本：点击放置、长按菜单、快捷操作、双指缩放（模拟）

### 验收标准

- 手机竖屏可完成“放置-连线-编辑-运行-观察”全流程
- 关键操作均有“非右键/非键盘”入口
- 组件和导线触控误触率显著下降（命中区统一后）

## 8. 分阶段实施建议

1. 第一阶段：修复断点与布局模式切换（不改核心交互）  
2. 第二阶段：上线长按菜单与快捷操作条  
3. 第三阶段：统一命中区与触控细节调优  
4. 第四阶段：补齐 E2E 回归与性能压测

