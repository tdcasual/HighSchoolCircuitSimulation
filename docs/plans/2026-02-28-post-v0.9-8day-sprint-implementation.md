# Post-v0.9 8-Day Sprint Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Deliver an 8-day, evidence-driven hardening sprint that closes architecture debt hotspots, KPI validity gaps, and release-gate consistency risks without breaking existing solver correctness.

**Architecture:** Execute in day-sized vertical slices with strict TDD and baseline gates. Keep behavior stable first, then refactor through compatibility adapters (`Circuit`/`Solver` facades). Separate synthetic engineering metrics from product-behavior metrics to prevent false UX success claims.

**Tech Stack:** Vanilla ES modules, Vitest, Playwright scripts, GitHub Actions, Node.js tooling.

---

## Execution Rules

1. Run in isolated worktree before Task 1.
2. Each task starts with a failing check/test.
3. Minimal code change to pass target checks.
4. Run required focused tests plus specified gates.
5. One task one commit where possible.

---

### Task 0: Prepare 8-Day Sprint Worktree

**Files:**
- Modify: none
- Test: none

**Step 1: Create worktree and branch**

Run:
```bash
git fetch origin
git worktree add ../HighSchoolCircuitSimulation-8day -b codex/post-v0.9-8day origin/main
```

Expected:
- New worktree created at `../HighSchoolCircuitSimulation-8day`.

**Step 2: Verify baseline**

Run:
```bash
cd ../HighSchoolCircuitSimulation-8day
npm run check:full
```

Expected:
- All gates green on starting point.

**Step 3: Baseline marker commit**

Run:
```bash
git commit --allow-empty -m "chore: start post-v0.9 8-day sprint"
```

---

### Task 1 (Day 1): Gate Hygiene and Evidence Integrity

**Files:**
- Modify: `.eslintrc.cjs`
- Modify: `.github/workflows/ci.yml`
- Modify: `package.json`
- Modify: `tests/ci.workflow.spec.js`
- Create: `scripts/ci/assert-release-doc-integrity.mjs`
- Create: `tests/release.docsIntegrity.spec.js`
- Create: `docs/process/component-interaction-usage-guide.md`
- Create: `scripts/ci/assert-interaction-guide-sync.mjs`
- Create: `tests/interaction.guideSync.spec.js`

**Step 1: Write failing tests**

```js
// tests/release.docsIntegrity.spec.js
import { describe, expect, it } from 'vitest';
import { readFileSync } from 'node:fs';
import { resolve } from 'node:path';

describe('release docs integrity', () => {
    it('references existing artifact paths in day28 review', () => {
        const content = readFileSync(resolve(process.cwd(), 'docs/audits/mobile/2026-03-29-day28-release-readiness-review.md'), 'utf8');
        expect(content).toContain('output/baselines/p0-electrical-current.json');
    });
});

describe('interaction guide sync', () => {
    it('documents current key interactions', () => {
        const content = readFileSync(resolve(process.cwd(), 'docs/process/component-interaction-usage-guide.md'), 'utf8');
        expect(content).toContain('Alt + 拖动端子');
        expect(content).toContain('Ctrl/Cmd + 点击导线');
    });
});
```

**Step 2: Run tests to verify failure**

Run:
```bash
npm test -- tests/release.docsIntegrity.spec.js tests/interaction.guideSync.spec.js
```

Expected:
- FAIL due to missing integrity script/coverage details.

**Step 3: Implement minimal gate fixes**

```js
// .eslintrc.cjs (ignore generated outputs)
ignorePatterns: ['node_modules/', 'output/', 'dist/', '.worktrees/', '_reference/'],
```

```yaml
# .github/workflows/ci.yml (quality job)
- name: Check release docs integrity
  run: node scripts/ci/assert-release-doc-integrity.mjs
- name: Check interaction guide sync
  run: node scripts/ci/assert-interaction-guide-sync.mjs
```

```md
# docs/process/component-interaction-usage-guide.md
| 行为 | 操作 | 说明 |
|---|---|---|
| 引脚伸缩 | Alt + 拖动端子 | 可拉长/缩短元器件引脚 |
| 导线分割 | Ctrl/Cmd + 点击导线 | 在点击处切分导线段 |
```

**Step 4: Run verification**

Run:
```bash
npm test -- tests/ci.workflow.spec.js tests/release.docsIntegrity.spec.js tests/interaction.guideSync.spec.js
npm run check
```

Expected:
- Gate hygiene tests pass.
- Lint no longer reports generated-file noise from `dist/`.
- Interaction usage guide sync checks pass.

**Step 5: Commit**

```bash
git add .eslintrc.cjs .github/workflows/ci.yml package.json tests/ci.workflow.spec.js scripts/ci/assert-release-doc-integrity.mjs scripts/ci/assert-interaction-guide-sync.mjs tests/release.docsIntegrity.spec.js tests/interaction.guideSync.spec.js docs/process/component-interaction-usage-guide.md
git commit -m "build: add interaction usage guide and sync gate checks"
```

---

### Task 2 (Day 2): Runtime Diagnostics Unification

**Files:**
- Modify: `src/main.js`
- Modify: `src/engine/Circuit.js`
- Create: `tests/runtimeDiagnostics.pipeline.spec.js`
- Modify: `tests/circuit.runtimeDiagnostics.spec.js`
- Modify: `tests/circuitAIAgent.spec.js`

**Step 1: Write failing pipeline test**

```js
// tests/runtimeDiagnostics.pipeline.spec.js
import { describe, expect, it } from 'vitest';

describe('runtime diagnostics pipeline', () => {
    it('uses circuit-produced diagnostics without recompute overwrite', () => {
        const diagnostics = { code: 'SHORT_CIRCUIT', summary: 'x', hints: [] };
        const results = { valid: false, runtimeDiagnostics: diagnostics };
        expect(results.runtimeDiagnostics).toBe(diagnostics);
    });
});
```

**Step 2: Run to verify failure**

Run:
```bash
npm test -- tests/runtimeDiagnostics.pipeline.spec.js
```

Expected:
- FAIL after adding stricter assertions against current overwrite path.

**Step 3: Implement minimal unification**

```js
// src/main.js
const runtimeDiagnostics = results?.runtimeDiagnostics
    || this.circuit.collectRuntimeDiagnostics(results, this.circuit.simTime);
if (results && typeof results === 'object' && !results.runtimeDiagnostics) {
    results.runtimeDiagnostics = runtimeDiagnostics;
}
```

**Step 4: Verify**

Run:
```bash
npm test -- tests/runtimeDiagnostics.pipeline.spec.js tests/circuit.runtimeDiagnostics.spec.js tests/circuitAIAgent.spec.js tests/knowledgeResourceProvider.spec.js
```

Expected:
- Shared diagnostics flow passes all checks.

**Step 5: Commit**

```bash
git add src/main.js src/engine/Circuit.js tests/runtimeDiagnostics.pipeline.spec.js tests/circuit.runtimeDiagnostics.spec.js tests/circuitAIAgent.spec.js
git commit -m "refactor: unify runtime diagnostics producer and consumer pipeline"
```

---

### Task 3 (Day 3): Registry Coverage Matrix and Refactor Slice A

**Files:**
- Modify: `src/core/simulation/ComponentRegistry.js`
- Modify: `src/engine/Solver.js`
- Modify: `src/core/simulation/ResultPostprocessor.js`
- Create: `docs/audits/reliability/2026-04-01-component-registry-coverage-matrix.md`
- Modify: `tests/simulation.componentRegistry.spec.js`

**Step 1: Add failing registry completeness test**

```js
// tests/simulation.componentRegistry.spec.js
it('covers all component defaults with at least stamp or current handler', () => {
    // assert every supported type has registry handler coverage
});
```

**Step 2: Run to verify failure**

Run:
```bash
npm test -- tests/simulation.componentRegistry.spec.js
```

Expected:
- FAIL for uncovered types.

**Step 3: Implement minimal handler expansion**

```js
// src/core/simulation/ComponentRegistry.js
DefaultComponentRegistry.register('Thermistor', { stamp: ..., current: ... });
DefaultComponentRegistry.register('Photoresistor', { stamp: ..., current: ... });
DefaultComponentRegistry.register('Ammeter', { stamp: ..., current: ... });
```

**Step 4: Verify**

Run:
```bash
npm test -- tests/simulation.componentRegistry.spec.js tests/solver.newComponents.spec.js tests/solver.commonCases.spec.js
npm run baseline:p0
```

Expected:
- Registry coverage test green and electrical baseline stable.

**Step 5: Commit**

```bash
git add src/core/simulation/ComponentRegistry.js src/engine/Solver.js src/core/simulation/ResultPostprocessor.js tests/simulation.componentRegistry.spec.js docs/audits/reliability/2026-04-01-component-registry-coverage-matrix.md
git commit -m "refactor: expand component registry coverage for solver path"
```

---

### Task 4 (Day 4): NetlistBuilder First Real Solve Path

**Files:**
- Modify: `src/core/simulation/NetlistBuilder.js`
- Modify: `src/engine/Circuit.js`
- Modify: `src/engine/Solver.js`
- Modify: `tests/simulation.netlistBuilder.spec.js`
- Create: `tests/solver.netlistPath.spec.js`

**Step 1: Add failing test for non-pass-through DTO**

```js
// tests/simulation.netlistBuilder.spec.js
it('builds explicit DTO entries for component terminals and node indices', () => {
    // expect netlist component entries with type/id/nodes/params fields
});
```

**Step 2: Run and confirm fail**

Run:
```bash
npm test -- tests/simulation.netlistBuilder.spec.js tests/solver.netlistPath.spec.js
```

Expected:
- FAIL because current builder is pass-through.

**Step 3: Implement minimal compatible DTO path**

```js
// NetlistBuilder returns normalized DTO with explicit arrays
return { nodes: normalizedNodes, components: normalizedComponents, meta: { version: 1 } };
```

```js
// Circuit/Solver consume DTO for one guarded path
this.netlist = this.netlistBuilder.build({ components, nodes });
```

**Step 4: Verify**

Run:
```bash
npm test -- tests/simulation.netlistBuilder.spec.js tests/solver.netlistPath.spec.js tests/solver.goldenScenarios.spec.js
npm run baseline:p0
```

Expected:
- Netlist path tests pass and baseline remains green.

**Step 5: Commit**

```bash
git add src/core/simulation/NetlistBuilder.js src/engine/Circuit.js src/engine/Solver.js tests/simulation.netlistBuilder.spec.js tests/solver.netlistPath.spec.js
git commit -m "refactor: introduce first production netlist DTO solve path"
```

---

### Task 5 (Day 5): Mobile KPI Validity Upgrade

**Files:**
- Modify: `src/core/metrics/MobileFlowMetrics.js`
- Modify: `scripts/e2e/responsive-touch-regression.mjs`
- Create: `src/core/metrics/InteractionTelemetry.js`
- Create: `tests/mobileFlowMetrics.validity.spec.js`
- Create: `docs/audits/mobile/2026-04-03-kpi-validity-spec.md`

**Step 1: Add failing test for synthetic/real metric separation**

```js
// tests/mobileFlowMetrics.validity.spec.js
it('reports synthetic and behavior tiers separately', () => {
    // expect report.synthetic and report.behavior sections
});
```

**Step 2: Run and confirm fail**

Run:
```bash
npm test -- tests/mobileFlowMetrics.validity.spec.js
```

Expected:
- FAIL because current output has single mixed summary.

**Step 3: Implement minimal split**

```js
// MobileFlowMetrics summary
return {
    synthetic: { averageTapCount, successRate },
    behavior: { medianDurationMs, p90DurationMs, destructiveCancelRate }
};
```

**Step 4: Verify**

Run:
```bash
npm test -- tests/mobileFlowMetrics.validity.spec.js tests/mobileFlowMetrics.spec.js
npm run test:e2e:responsive
```

Expected:
- New validity tests pass and responsive artifact still generated.

**Step 5: Commit**

```bash
git add src/core/metrics/MobileFlowMetrics.js src/core/metrics/InteractionTelemetry.js scripts/e2e/responsive-touch-regression.mjs tests/mobileFlowMetrics.validity.spec.js docs/audits/mobile/2026-04-03-kpi-validity-spec.md
git commit -m "feat(metrics): separate synthetic and behavior KPI tiers for mobile flow"
```

---

### Task 6 (Day 6): Observation Performance Hardening

**Files:**
- Modify: `src/ui/ObservationPanel.js`
- Modify: `src/ui/observation/ObservationChartInteraction.js`
- Create: `scripts/benchmark/observation-stress-regression.mjs`
- Create: `tests/observation.performanceStress.spec.js`

**Step 1: Add failing stress test**

```js
// tests/observation.performanceStress.spec.js
it('keeps linked cursor lookup under defined budget for large sample set', () => {
    // assert bounded lookup operations / timing envelope
});
```

**Step 2: Run and confirm fail**

Run:
```bash
npm test -- tests/observation.performanceStress.spec.js
```

Expected:
- FAIL with current unoptimized path on large buffers.

**Step 3: Implement minimal optimization**

```js
// add lightweight index/stride search fallback before full scan
// keep behavior identical for small buffers
```

**Step 4: Verify**

Run:
```bash
npm test -- tests/observation.performanceStress.spec.js tests/observationChartInteraction.spec.js tests/observationPanel.renderLifecycle.spec.js
node scripts/benchmark/observation-stress-regression.mjs
```

Expected:
- Stress and interaction checks pass with benchmark artifact.

**Step 5: Commit**

```bash
git add src/ui/ObservationPanel.js src/ui/observation/ObservationChartInteraction.js scripts/benchmark/observation-stress-regression.mjs tests/observation.performanceStress.spec.js
git commit -m "perf(observation): harden linked-cursor and render path for large buffers"
```

---

### Task 7 (Day 7): AI Teaching Reliability Tightening

**Files:**
- Modify: `src/ai/resources/KnowledgeResourceProvider.js`
- Modify: `src/ai/agent/CircuitAIAgent.js`
- Modify: `tests/knowledgeResourceProvider.spec.js`
- Create: `tests/aiTeaching.reliability.spec.js`
- Create: `scripts/benchmark/ai-teaching-mini-eval.mjs`

**Step 1: Add failing deterministic reliability test**

```js
// tests/aiTeaching.reliability.spec.js
it('produces stable what-why-how structure for canonical failure categories', async () => {
    // assert ordered structure and non-empty repair guidance
});
```

**Step 2: Run and confirm fail**

Run:
```bash
npm test -- tests/aiTeaching.reliability.spec.js
```

Expected:
- FAIL until deterministic selection/fallback rules are tightened.

**Step 3: Implement minimal rule hardening**

```js
// deterministic priority + fallback copy when diagnostic context is partial
```

**Step 4: Verify**

Run:
```bash
npm test -- tests/aiTeaching.reliability.spec.js tests/knowledgeResourceProvider.spec.js tests/circuitAIAgent.spec.js
node scripts/benchmark/ai-teaching-mini-eval.mjs
```

Expected:
- Reliability tests pass and mini-eval artifact produced.

**Step 5: Commit**

```bash
git add src/ai/resources/KnowledgeResourceProvider.js src/ai/agent/CircuitAIAgent.js tests/aiTeaching.reliability.spec.js tests/knowledgeResourceProvider.spec.js scripts/benchmark/ai-teaching-mini-eval.mjs
git commit -m "feat(ai): tighten deterministic teaching guidance for runtime diagnostics"
```

---

### Task 8 (Day 8): Sprint Closure and Release Readiness Gate

**Files:**
- Create: `docs/releases/v1.0-8day-readiness-gate.md`
- Create: `docs/releases/v1.0-8day-go-no-go-matrix.md`
- Create: `docs/audits/mobile/2026-04-06-sprint-closure-review.md`
- Modify: `README.md`
- Modify: `docs/process/component-interaction-usage-guide.md`

**Step 1: Add failing CI-doc consistency test**

```js
// tests/release.docsIntegrity.spec.js
it('includes new 8-day readiness artifacts in release docs index', () => {
    // assert new docs are referenced
});

it('interaction guide was reviewed in sprint closure', () => {
    // assert closure doc references latest interaction guide revision
});
```

**Step 2: Run and confirm fail**

Run:
```bash
npm test -- tests/release.docsIntegrity.spec.js
```

Expected:
- FAIL until closure docs are created and linked.

**Step 3: Produce closure artifacts and link index**

```md
## Go/No-Go
- blocker count
- residual risk list
- rollback readiness

## Interaction Guide Review
- confirmed latest interaction behaviors and keybindings
- updated `docs/process/component-interaction-usage-guide.md` when behavior changed
```

**Step 4: Final verification gates**

Run:
```bash
npm run check:full
npm run test:e2e:responsive
npm run test:e2e:wire
npm run test:e2e:observation
npm test -- tests/interaction.guideSync.spec.js
```

Expected:
- All gates pass and artifacts captured.
- Interaction guide sync gate remains green on final snapshot.

**Step 5: Commit**

```bash
git add docs/releases/v1.0-8day-readiness-gate.md docs/releases/v1.0-8day-go-no-go-matrix.md docs/audits/mobile/2026-04-06-sprint-closure-review.md README.md docs/process/component-interaction-usage-guide.md tests/release.docsIntegrity.spec.js tests/interaction.guideSync.spec.js
git commit -m "docs(release): close 8-day sprint with interaction-guide sync evidence"
```

---

## Daily Reporting Template (Mandatory)

At the end of each day, publish:

1. Commands executed.
2. Pass/fail summary.
3. Artifact paths.
4. Residual risks and carry-over.

---

## Final Handoff Criteria

The sprint is complete only when:

1. All task-level focused tests are green.
2. `npm run check:full` is green on final head.
3. Mobile/observation/AI evidence artifacts are present and referenced.
4. Go/no-go matrix and closure review are complete.
