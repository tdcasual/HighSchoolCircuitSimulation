# 电路模拟器 Bug 修复记录

## 修复日期: 2025-12-03

## 已修复的问题

### Bug 1: 元器件放置重复
**问题描述**: 从工具箱拖放元器件到画布时，会创建2个相同的元器件。

**根本原因**: 
- `drop` 事件同时绑定到 `#canvas-container` 和 `#circuit-canvas`，导致重复触发
- 使用了通用的 `text/plain` MIME 类型，可能与其他拖放操作混淆
- SVG 元素的原生拖放没有被禁止

**修复方案**:
1. 只在 SVG 画布上绑定 `drop` 事件，移除容器的绑定
2. 使用自定义 MIME 类型 `application/x-circuit-component` 区分工具箱拖放
3. 添加 `e.stopPropagation()` 防止事件冒泡
4. CSS 禁用 SVG 元素的原生拖放 (`-webkit-user-drag: none`)
5. 设置 `draggable="false"` 属性

**涉及文件**: `src/ui/Interaction.js`, `src/components/Component.js`, `css/style.css`

---

### Bug 2: 滑动变阻器端子无法使用
**问题描述**: 滑动变阻器的端子（特别是靠近滑块的一侧）无法点击进行连线。

**根本原因**:
- 端子的 `pointer-events` 没有正确设置
- 滑块元素可能遮挡了端子

**修复方案**:
1. 端子添加 `pointer-events: all` 样式确保可点击
2. 调整渲染顺序，确保端子在最上层
3. CSS 中添加 `.terminal { pointer-events: all !important; }`
4. 端子点击时验证 `dataset.terminal` 索引有效性

**涉及文件**: `src/components/Component.js`, `src/ui/Interaction.js`, `css/style.css`

---

### Bug 3: 编辑电源内阻后元器件消失
**问题描述**: 第二次编辑电源的内阻后，电源元器件从画布上消失。

**根本原因**:
- 数值解析不安全，可能产生 `NaN`
- 内阻为0时导致 MNA 矩阵奇异
- 无效参数值导致渲染失败

**修复方案**:
1. 添加 `safeParseFloat()` 函数进行安全的数值解析
2. 对所有参数添加最小/最大值约束
3. 内阻最小值设为 `1e-9` 避免奇异矩阵
4. 添加 try-catch 保护防止崩溃

**涉及文件**: `src/ui/Interaction.js`

---

### Bug 4: 电源电流显示错误
**问题描述**: 电源显示的电流是 U/r（电动势/内阻），不符合真实物理规律。应该是整个回路的电流。

**根本原因**:
- MNA 求解器中电源电流的计算方式错误
- 没有正确使用电压源的支路电流变量
- 内阻和电压源的建模方式不正确

**修复方案**:
1. 修正 MNA 印记方法，正确建模电压源和内阻
2. 电流从 MNA 解向量的支路电流变量获取
3. 修正电流方向约定（取反以表示放电方向）
4. 端子电压正确计算为：`U = EMF - I × r`
5. 电源功率正确计算为：`P = U × I`（端子电压 × 电流）

**涉及文件**: `src/engine/Solver.js`, `src/engine/Circuit.js`

---

## 测试验证

### 测试 1: 元器件放置（验证 Bug 1 修复）
1. 从工具箱拖放任意元器件到画布 → 只创建1个元器件
2. 拖动已放置的元器件移动位置 → 不创建新元器件
3. 快速连续拖放多个元器件 → 每次只创建1个

### 测试 2: 滑动变阻器端子（验证 Bug 2 修复）
1. 放置滑动变阻器
2. 点击左侧端子 → 成功开始连线
3. 点击右侧端子 → 成功开始连线
4. 两个端子都能正常使用

### 测试 3: 属性编辑（验证 Bug 3 修复）
1. 放置电源
2. 双击编辑内阻为 0 → 自动转换为极小值，元器件保持存在
3. 再次编辑内阻为 5 → 元器件保持存在
4. 输入无效值（空、负数）→ 使用安全默认值

### 测试 4: 电流计算（验证 Bug 4 修复）
简单串联电路：电源(EMF=12V, r=1Ω) → 电阻(R=11Ω) → 闭合回路

**预期结果**:
- 回路电流 I = E / (R + r) = 12 / 12 = 1A
- 电源端子电压 U = E - I×r = 12 - 1×1 = 11V  
- 电阻电压 = I×R = 1×11 = 11V
- 电源输出功率 P = U×I = 11×1 = 11W
- 电阻消耗功率 = 11W

---

## 物理模型说明

### 电源等效电路
```
    +----[r内阻]----+
    |               |
   (+)             (-)
    |      EMF      |
    +-------||------+
```

### MNA 建模
- 电压源变量：表示电动势 EMF
- 支路电流变量：表示通过电源的电流 I
- 内阻作为并联电阻建模
- 端子电压 = EMF - I × r

### 电流方向约定
- 正电流：从电源正极流出（放电）
- 负电流：流入电源正极（充电，如电容充电后的振荡）
